<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pok√©mon-like Game</title>
    <style>
        * { margin: 0; padding: 0; }
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #renderCanvas {
            width: 100%;
            height: 100vh;
            display: block;
        }
        #instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.8;
            z-index: 1000;
            pointer-events: none;
        }
        #instructions strong { color: #FFD700; }

        /* ========= OVERLAY / BLUR ========= */
        #menuOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 900;
        }
        #menuOverlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* ========= FEN√äTRES DE MENU ========= */
        .menu-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 420px;
            max-width: 90%;
            background: radial-gradient(circle at top, #1a3b7a, #051024);
            border: 3px solid #FFD700;
            border-radius: 18px;
            padding: 18px 20px;
            color: white;
            box-shadow: 0 10px 26px rgba(0,0,0,0.6);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 1000;
        }
        .menu-window.open {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .menu-title {
            font-size: 24px;
            color: #FFD700;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 4px black;
        }
        .menu-subtitle {
            font-size: 13px;
            text-align: center;
            color: #d0d8ff;
            margin-bottom: 10px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 6px;
        }
        .menu-btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, #1b4d9a, #153a74);
            color: white;
            font-size: 15px;
            text-align: left;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
        }
        .menu-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.6);
            background: linear-gradient(90deg, #2464c4, #184386);
        }

        .menu-btn.danger {
            background: linear-gradient(90deg, #8d1c1c, #5c1010);
        }
        .menu-btn.danger:hover {
            background: linear-gradient(90deg, #b12525, #6d1515);
        }

        /* ========= INVENTAIRE ========= */
        #inventoryMenu {
            width: 600px;
            max-width: 95%;
        }
        #inventoryGrid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
            margin: 10px 0 8px;
        }
        .inv-item {
            background: rgba(15, 40, 90, 0.95);
            border-radius: 12px;
            padding: 8px 6px;
            text-align: center;
            border: 2px solid rgba(0,255,255,0.4);
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.5);
        }
        .inv-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.7);
            border-color: rgba(255,255,0,0.8);
        }
        .inv-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }
        .inv-name {
            font-size: 12px;
        }
        .inv-count {
            font-size: 13px;
            color: #ffe780;
        }

        #inventoryDetail {
            margin-top: 6px;
            padding: 8px;
            border-radius: 12px;
            background: rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }
        #inventoryDetail.show {
            display: block;
        }
        #inventoryDetailTitle {
            font-size: 16px;
            color: #FFD700;
            margin-bottom: 4px;
        }
        #inventoryDetailDesc {
            font-size: 13px;
            margin-bottom: 6px;
        }
        .detail-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .detail-btn {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: #1b4d9a;
            color: white;
        }
        .detail-btn.secondary {
            background: #555;
        }

        .menu-footer {
            margin-top: 8px;
            text-align: right;
            font-size: 12px;
            color: #aeb8ff;
        }

        /* ========= √âQUIPE ========= */
        #teamMenu {
            width: 520px;
            max-width: 95%;
        }
        #teamList {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        .team-card {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(10, 35, 80, 0.95);
            border: 2px solid rgba(255,215,0,0.4);
            box-shadow: 0 3px 7px rgba(0,0,0,0.6);
        }
        .team-icon {
            font-size: 28px;
        }
        .team-main {
            flex: 1;
        }
        .team-name {
            font-size: 15px;
        }
        .team-level {
            font-size: 12px;
            color: #d0d8ff;
        }
        .team-hpbar-wrap {
            margin-top: 4px;
            background: #222;
            border-radius: 6px;
            overflow: hidden;
            height: 8px;
        }
        .team-hpbar {
            height: 100%;
            background: linear-gradient(90deg, #28c728, #8be628);
        }
        .team-extra {
            font-size: 12px;
            text-align: right;
            color: #ffdede;
        }

        /* ========= DIALOGUE ========= */
        #dialogBox {
            position: fixed;
            left: 50%;
            bottom: 20px;
            transform: translateX(-50%);
            width: 80%;
            max-width: 700px;
            background: rgba(0,0,0,0.9);
            border-radius: 12px;
            border: 2px solid white;
            color: white;
            padding: 10px 14px;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: 0 6px 15px rgba(0,0,0,0.7);
            display: none;
            z-index: 1200;
        }
        #dialogBox.show {
            display: block;
        }

        /* ========= PETIT HUD ========= */
        #hudSpeed {
            position: fixed;
            right: 15px;
            bottom: 15px;
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 12px;
            background: rgba(0,0,0,0.7);
            color: white;
            z-index: 1100;
        }
        #hudSpeed span {
            font-weight: bold;
        }
    </style>
</head>
<body>
<canvas id="renderCanvas"></canvas>

<div id="instructions">
    <strong>üéÆ Contr√¥les:</strong><br>
    ZQSD : D√©placer<br>
    Shift : Courir<br>
    E : Interagir<br>
    M : Menu<br><br>
    <strong>Manette:</strong><br>
    A : Courir | B : Interagir | Y : Menu
</div>

<!-- Overlay flout√© -->
<div id="menuOverlay"></div>

<!-- MENU PRINCIPAL -->
<div id="mainMenu" class="menu-window">
    <div class="menu-title">‚öîÔ∏è MENU ‚öîÔ∏è</div>
    <div class="menu-subtitle">Dresseur: <span id="trainerName">Red</span> ‚Äî <span id="trainerMoney">500‚ÇΩ</span></div>
    <div class="menu-buttons">
        <button class="menu-btn" id="btnMenuInventory">üì¶ Inventaire</button>
        <button class="menu-btn" id="btnMenuTeam">üë• √âquipe</button>
        <button class="menu-btn" id="btnMenuMap">üó∫Ô∏è Carte</button>
        <button class="menu-btn" id="btnMenuSave">üíæ Sauvegarder</button>
        <button class="menu-btn" id="btnMenuOptions">‚öôÔ∏è Options</button>
        <button class="menu-btn danger" id="btnMenuClose">‚ùå Fermer</button>
    </div>
</div>

<!-- MENU INVENTAIRE -->
<div id="inventoryMenu" class="menu-window">
    <div class="menu-title">üì¶ INVENTAIRE</div>
    <div class="menu-subtitle">S√©lectionne un objet pour voir les options.</div>

    <div id="inventoryGrid"></div>

    <div id="inventoryDetail">
        <div id="inventoryDetailTitle"></div>
        <div id="inventoryDetailDesc"></div>
        <div class="detail-buttons">
            <button class="detail-btn" id="btnUseItem">Utiliser</button>
            <button class="detail-btn" id="btnInfoItem">Infos</button>
            <button class="detail-btn secondary" id="btnBackItem">Retour</button>
        </div>
    </div>

    <div class="menu-footer">
        <button class="detail-btn secondary" id="btnInventoryBack">‚¨Ö Retour au menu</button>
    </div>
</div>

<!-- MENU √âQUIPE -->
<div id="teamMenu" class="menu-window">
    <div class="menu-title">üë• √âQUIPE</div>
    <div class="menu-subtitle">Tes Pok√©mon actuels.</div>

    <div id="teamList"></div>

    <div class="menu-footer">
        <button class="detail-btn secondary" id="btnTeamBack">‚¨Ö Retour au menu</button>
    </div>
</div>

<!-- DIALOGUE -->
<div id="dialogBox"><span id="dialogText"></span></div>

<!-- HUD -->
<div id="hudSpeed">Vitesse : <span id="hudSpeedText">üö∂ Marche</span></div>

<script src="https://cdn.babylonjs.com/babylon.js?v=6.40"></script>

<script>
console.log("üéÆ D√©marrage du jeu...");

const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });

let gamepad = null;

const gameState = {
    menuOpen: false,
    dialogOpen: false,
    isRunning: false,
    interactionRange: 3,
    playerInventory: [
        {name: "Potion", count: 3, icon: "üß™", description: "Restaure un peu de PV."},
        {name: "Pok√© Ball", count: 5, icon: "‚ö™", description: "Permet de capturer des Pok√©mon."},
        {name: "Antidote", count: 1, icon: "üíä", description: "Soigne l‚Äôempoisonnement."}
    ],
    team: [
        {name: "Pikachu", level: 12, hp: 30, maxHp: 35, icon: "‚ö°", status: "OK"},
        {name: "Salam√®che", level: 10, hp: 28, maxHp: 30, icon: "üî•", status: "OK"},
        {name: "Carapuce", level: 9, hp: 22, maxHp: 28, icon: "üíß", status: "OK"}
    ],
    playerName: "Red",
    money: 500,
    selectedItemIndex: null
};

// ====== R√âF√âRENCES DOM ======
const overlayEl = document.getElementById("menuOverlay");
const mainMenuEl = document.getElementById("mainMenu");
const inventoryMenuEl = document.getElementById("inventoryMenu");
const teamMenuEl = document.getElementById("teamMenu");
const dialogBoxEl = document.getElementById("dialogBox");
const dialogTextEl = document.getElementById("dialogText");
const hudSpeedTextEl = document.getElementById("hudSpeedText");

const trainerNameEl = document.getElementById("trainerName");
const trainerMoneyEl = document.getElementById("trainerMoney");

// Boutons menu principal
const btnMenuInventory = document.getElementById("btnMenuInventory");
const btnMenuTeam = document.getElementById("btnMenuTeam");
const btnMenuMap = document.getElementById("btnMenuMap");
const btnMenuSave = document.getElementById("btnMenuSave");
const btnMenuOptions = document.getElementById("btnMenuOptions");
const btnMenuClose = document.getElementById("btnMenuClose");

// Inventaire DOM
const inventoryGridEl = document.getElementById("inventoryGrid");
const inventoryDetailEl = document.getElementById("inventoryDetail");
const inventoryDetailTitleEl = document.getElementById("inventoryDetailTitle");
const inventoryDetailDescEl = document.getElementById("inventoryDetailDesc");
const btnUseItemEl = document.getElementById("btnUseItem");
const btnInfoItemEl = document.getElementById("btnInfoItem");
const btnBackItemEl = document.getElementById("btnBackItem");
const btnInventoryBackEl = document.getElementById("btnInventoryBack");

// √âquipe DOM
const teamListEl = document.getElementById("teamList");
const btnTeamBackEl = document.getElementById("btnTeamBack");

// ========== BABYLON SCENE ==========
function createScene() {
    const scene = new BABYLON.Scene(engine);
    scene.collisionsEnabled = true;

    console.log("üåç Cr√©ation de la sc√®ne...");

    // Lumi√®re
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);
    light.intensity = 1.2;

    // Sol
    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width:50, height:50}, scene);
    const groundMat = new BABYLON.StandardMaterial("gm", scene);
    groundMat.diffuseColor = new BABYLON.Color3(0.3, 0.7, 0.3);
    ground.material = groundMat;
    ground.checkCollisions = true;

    // Player collider
    const playerCollider = BABYLON.MeshBuilder.CreateBox("pc", {width:1, height:1, depth:1}, scene);
    playerCollider.position = new BABYLON.Vector3(0,0.5,0);
    playerCollider.isVisible = false;
    playerCollider.checkCollisions = true;
    playerCollider.ellipsoid = new BABYLON.Vector3(0.5,0.5,0.5);
    playerCollider.ellipsoidOffset = new BABYLON.Vector3(0,0.5,0);

    // Player mesh
    const player = BABYLON.MeshBuilder.CreateSphere("player",{diameter:1},scene);
    const pmat = new BABYLON.PBRMaterial("pmat", scene);
    pmat.albedoColor = new BABYLON.Color3(1,0.4,0);
    player.material = pmat;
    player.parent = playerCollider;

    // ===== PNJ =====
    const npc = BABYLON.MeshBuilder.CreateBox("npc", {
        height: 1.8,
        width: 0.8,
        depth: 0.8
    }, scene);
    npc.position = new BABYLON.Vector3(5, 0.9, 5);
    npc.material = new BABYLON.StandardMaterial("npcMat", scene);
    npc.material.diffuseColor = new BABYLON.Color3(0, 0, 1);
    npc.checkCollisions = true;

    // ===== INDICATEUR PNG AU-DESSUS DU PNJ =====
    const npcIcon = BABYLON.MeshBuilder.CreatePlane("npcIcon", {
        width: 0.7,
        height: 1.2
    }, scene);

    npcIcon.position = npc.position.add(new BABYLON.Vector3(0, 1.9, 0));
    npcIcon.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;

    const npcIconMat = new BABYLON.StandardMaterial("npcIconMat", scene);
    // Chemin EXACT de ton image (Assets/icons dans ton projet)
    npcIconMat.diffuseTexture = new BABYLON.Texture(
        "Assets/icons/Point-exclamation.png",
        scene
    );
    npcIconMat.diffuseTexture.hasAlpha = true;
    npcIconMat.backFaceCulling = false;
    npcIconMat.emissiveColor = new BABYLON.Color3(1,1,1);
    npcIcon.material = npcIconMat;
    npcIcon.isVisible = false;

    // Item au sol
    const item = BABYLON.MeshBuilder.CreateSphere("item",{diameter:0.6},scene);
    item.position = new BABYLON.Vector3(-5,0.4,-3);
    item.material = new BABYLON.StandardMaterial("itemMat",scene);
    item.material.emissiveColor = new BABYLON.Color3(1,0.7,0);

    // Murs
    function wall(x,z,w,h,d) {
        const box = BABYLON.MeshBuilder.CreateBox("wall",{width:w,height:h,depth:d},scene);
        box.position = new BABYLON.Vector3(x,h/2,z);
        box.checkCollisions = true;
        box.isVisible = false;
    }
    wall(0,25,50,3,1);
    wall(0,-25,50,3,1);
    wall(25,0,1,3,50);
    wall(-25,0,1,3,50);

    // Cam√©ra
    const camera = new BABYLON.FollowCamera("cam", new BABYLON.Vector3(0,17,-20), scene);
    camera.lockedTarget = playerCollider;
    camera.radius = 20;
    camera.heightOffset = 17;
    camera.rotationOffset = 90;

    // ===== DIALOGUE (HTML) =====
    function showDialog(text) {
        console.log("üí¨", text);
        dialogTextEl.textContent = text;
        dialogBoxEl.classList.add("show");
        gameState.dialogOpen = true;
        overlayEl.classList.add("visible");

        setTimeout(() => {
            dialogBoxEl.classList.remove("show");
            gameState.dialogOpen = false;
            if (!gameState.menuOpen) {
                overlayEl.classList.remove("visible");
            }
        }, 2800);
    }

    // ===== MENUS HTML =====
    function openMainMenu() {
        console.log("üìã Ouverture menu principal");
        gameState.menuOpen = true;
        overlayEl.classList.add("visible");
        mainMenuEl.classList.add("open");
        inventoryMenuEl.classList.remove("open");
        teamMenuEl.classList.remove("open");
        inventoryDetailEl.classList.remove("show");
        gameState.selectedItemIndex = null;
    }

    function closeAllMenus() {
        console.log("‚ùå Fermeture menus");
        gameState.menuOpen = false;
        mainMenuEl.classList.remove("open");
        inventoryMenuEl.classList.remove("open");
        teamMenuEl.classList.remove("open");
        inventoryDetailEl.classList.remove("show");
        gameState.selectedItemIndex = null;
        if (!gameState.dialogOpen) {
            overlayEl.classList.remove("visible");
        }
    }

    function openInventoryMenu() {
        mainMenuEl.classList.remove("open");
        inventoryMenuEl.classList.add("open");
        inventoryDetailEl.classList.remove("show");
        renderInventory();
    }

    function openTeamMenu() {
        mainMenuEl.classList.remove("open");
        teamMenuEl.classList.add("open");
        renderTeam();
    }

    function toggleMenu() {
        if (gameState.menuOpen) closeAllMenus();
        else openMainMenu();
    }

    // ===== INVENTAIRE (HTML) =====
    function renderInventory() {
        inventoryGridEl.innerHTML = "";
        gameState.playerInventory.forEach((it, idx) => {
            const card = document.createElement("div");
            card.className = "inv-item";
            card.innerHTML = `
                <div class="inv-icon">${it.icon}</div>
                <div class="inv-name">${it.name}</div>
                <div class="inv-count">x${it.count}</div>
            `;
            card.addEventListener("click", () => openItemDetail(idx));
            inventoryGridEl.appendChild(card);
        });
    }

    function openItemDetail(index) {
        const it = gameState.playerInventory[index];
        if (!it) return;
        gameState.selectedItemIndex = index;
        inventoryDetailTitleEl.textContent = `${it.icon} ${it.name}`;
        inventoryDetailDescEl.textContent = it.description || "Aucune description.";
        inventoryDetailEl.classList.add("show");
    }

    btnUseItemEl.addEventListener("click", () => {
        const idx = gameState.selectedItemIndex;
        if (idx == null) return;
        const it = gameState.playerInventory[idx];
        if (!it) return;

        showDialog(`Tu utilises ${it.name} !`);
        it.count--;
        if (it.count <= 0) {
            gameState.playerInventory.splice(idx, 1);
            gameState.selectedItemIndex = null;
            inventoryDetailEl.classList.remove("show");
        }
        renderInventory();
    });

    btnInfoItemEl.addEventListener("click", () => {
        const idx = gameState.selectedItemIndex;
        if (idx == null) return;
        const it = gameState.playerInventory[idx];
        showDialog(`${it.icon} ${it.name} : ${it.description || "Objet myst√©rieux."}`);
    });

    btnBackItemEl.addEventListener("click", () => {
        inventoryDetailEl.classList.remove("show");
        gameState.selectedItemIndex = null;
    });

    btnInventoryBackEl.addEventListener("click", () => {
        openMainMenu();
    });

    // ===== √âQUIPE (HTML) =====
    function hpColor(pct) {
        if (pct > 0.5) return "linear-gradient(90deg,#28c728,#8be628)";
        if (pct > 0.2) return "linear-gradient(90deg,#e6c228,#f6e46b)";
        return "linear-gradient(90deg,#e62828,#f66b6b)";
    }

    function renderTeam() {
        teamListEl.innerHTML = "";
        gameState.team.forEach(pk => {
            const pct = pk.hp / pk.maxHp;
            const card = document.createElement("div");
            card.className = "team-card";
            card.innerHTML = `
                <div class="team-icon">${pk.icon}</div>
                <div class="team-main">
                    <div class="team-name">${pk.name}</div>
                    <div class="team-level">Niv. ${pk.level} ‚Äî ${pk.hp}/${pk.maxHp} PV</div>
                    <div class="team-hpbar-wrap">
                        <div class="team-hpbar" style="width:${pct*100}%;background:${hpColor(pct)};"></div>
                    </div>
                </div>
                <div class="team-extra">${pk.status}</div>
            `;
            teamListEl.appendChild(card);
        });
    }

    btnTeamBackEl.addEventListener("click", () => {
        openMainMenu();
    });

    // ===== BOUTONS MENU PRINCIPAL =====
    trainerNameEl.textContent = gameState.playerName;
    trainerMoneyEl.textContent = gameState.money + "‚ÇΩ";

    btnMenuInventory.addEventListener("click", () => openInventoryMenu());
    btnMenuTeam.addEventListener("click", () => openTeamMenu());
    btnMenuMap.addEventListener("click", () => showDialog("üó∫Ô∏è La carte n'est pas encore disponible."));
    btnMenuSave.addEventListener("click", () => showDialog("üíæ Partie sauvegard√©e !"));
    btnMenuOptions.addEventListener("click", () => showDialog("‚öôÔ∏è Options en d√©veloppement."));
    btnMenuClose.addEventListener("click", () => closeAllMenus());

    // ===== INTERACTION =====
    function interact() {
        if (gameState.menuOpen || gameState.dialogOpen) return;

        const pos = playerCollider.position;
        const distNpc = BABYLON.Vector3.Distance(pos, npc.position);

        if (distNpc < gameState.interactionRange) {
            showDialog("Salut dresseur ! Bonne chance !");
            return;
        }

        if (item.isVisible && BABYLON.Vector3.Distance(pos, item.position) < gameState.interactionRange) {
            showDialog("Tu trouves une Hyper Potion !");
            item.isVisible = false;
            gameState.playerInventory.push({
                name:"Hyper Potion",
                count:1,
                icon:"üß™",
                description:"Restaure beaucoup de PV."
            });
            renderInventory();
        }
    }

    // ===== CLAVIER =====
    const inputMap = {};
    const keyJustPressed = {};

    scene.onKeyboardObservable.add(e => {
        const k = e.event.key.toLowerCase();

        if (e.type === BABYLON.KeyboardEventTypes.KEYDOWN) {
            if (!keyJustPressed[k]) {
                keyJustPressed[k] = true;
                inputMap[k] = true;

                if (k === "e") interact();
                if (k === "m") toggleMenu();
                if (e.event.key === "Escape") closeAllMenus();
                if (e.event.key === "Shift") gameState.isRunning = true;
            }
        }

        if (e.type === BABYLON.KeyboardEventTypes.KEYUP) {
            inputMap[k] = false;
            keyJustPressed[k] = false;
            if (e.event.key === "Shift") gameState.isRunning = false;
        }
    });

    // ===== GAMEPAD (simple) =====
    const GP = {courir:0, interagir:1, menu:3};
    const pressed = {};
    let lastGPPress = {};

    new BABYLON.GamepadManager().onGamepadConnectedObservable.add(gp => {
        gamepad = gp;
        console.log("üéÆ Manette connect√©e:", gp.id);

        gp.onButtonDownObservable.add(btn => {
            const b = typeof btn === "number" ? btn : btn.index || btn;
            if (pressed[b]) return;
            pressed[b] = true;
            const now = Date.now();

            if (b === GP.menu && (!lastGPPress.menu || now - lastGPPress.menu > 300)) {
                lastGPPress.menu = now;
                toggleMenu();
            }

            if (!gameState.menuOpen) {
                if (b === GP.interagir) interact();
                if (b === GP.courir) gameState.isRunning = true;
            }
        });

        gp.onButtonUpObservable.add(btn => {
            const b = typeof btn === "number" ? btn : btn.index || btn;
            pressed[b] = false;
            if (b === GP.courir) gameState.isRunning = false;
        });
    });

    // ===== MOUVEMENT =====
    scene.onBeforeRenderObservable.add(() => {
        hudSpeedTextEl.textContent = gameState.isRunning ? "üèÉ Course" : "üö∂ Marche";

        // Affichage de l'ic√¥ne PNG au-dessus du PNJ selon la distance
        const distNpc = BABYLON.Vector3.Distance(playerCollider.position, npc.position);
        npcIcon.isVisible = distNpc < gameState.interactionRange;

        if (gameState.menuOpen || gameState.dialogOpen) return;

        const spd = gameState.isRunning ? 0.2 : 0.1;
        let dx = 0, dz = 0;

        if (inputMap["z"] || inputMap["w"]) dx -= spd;
        if (inputMap["s"]) dx += spd;
        if (inputMap["d"]) dz += spd;
        if (inputMap["a"] || inputMap["q"]) dz -= spd;

        if (gamepad) {
            const D = 0.15;
            const lx = Math.abs(gamepad.leftStick.x) > D ? gamepad.leftStick.x : 0;
            const ly = Math.abs(gamepad.leftStick.y) > D ? gamepad.leftStick.y : 0;
            dz += lx * spd;
            dx -= ly * spd;
        }

        if (dx || dz) player.rotation.y = Math.atan2(dz, dx);
        playerCollider.moveWithCollisions(new BABYLON.Vector3(dx, 0, dz));
    });

    console.log("‚úÖ Sc√®ne pr√™te !");
    return scene;
}

const scene = createScene();
engine.runRenderLoop(() => scene.render());
window.addEventListener("resize", () => engine.resize());

console.log("üéÆ Jeu d√©marr√© ! Appuyez sur M pour le menu");
</script>
</body>
</html>
