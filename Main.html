<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pok√©mon-like Game</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #renderCanvas { width: 100%; height: 100vh; touch-action: none; }
        #instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.8;
            font-family: Arial, sans-serif;
        }
        #instructions strong { color: #FFD700; }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>

    <div id="instructions">
        <strong>üéÆ Contr√¥les Clavier:</strong><br>
        ZQSD / Fl√®ches : D√©placer<br>
        Shift : Courir<br>
        E : Interagir<br>
        M : Menu<br>
        √âchap : Fermer menu<br><br>
        <strong>üéÆ Contr√¥les Manette:</strong><br>
        Stick gauche : D√©placer<br>
        X : Courir<br>
        A : Interagir<br>
        Y : Menu
    </div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

let gamepad = null;

// √âtat global du jeu
const gameState = {
    menuOpen: false,
    dialogOpen: false,
    isRunning: false,
    interactionRange: 3,
    playerInventory: ["Potion x3", "Pok√© Ball x5", "Antidote x1"],
    playerName: "Red",
    money: 500
};

function createScene() {
    const scene = new BABYLON.Scene(engine);
    scene.collisionsEnabled = true;

    // LUMI√àRE + SOL
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width:50,height:50}, scene);
    const groundMat = new BABYLON.StandardMaterial("groundMat", scene);
    groundMat.diffuseColor = new BABYLON.Color3(0.3, 0.7, 0.3);
    ground.material = groundMat;
    ground.checkCollisions = true;

    // PLAYER
    const player = BABYLON.MeshBuilder.CreateSphere("player", {diameter:1}, scene);
    player.position = new BABYLON.Vector3(0,0.5,0);
    const mat = new BABYLON.PBRMaterial("pmat", scene);
    mat.albedoColor = new BABYLON.Color3(1,0.4,0);
    player.material = mat;

    // ‚≠ê AJOUT : COLLISIONS JOUEUR
    player.checkCollisions = true;
    player.ellipsoid = new BABYLON.Vector3(0.5,0.5,0.5);
    player.ellipsoidOffset = new BABYLON.Vector3(0,0.5,0);

    // NPC
    const npc = BABYLON.MeshBuilder.CreateBox("npc",{height:1.8,width:0.8,depth:0.8},scene);
    npc.position = new BABYLON.Vector3(5,0.9,5);
    npc.checkCollisions = true;

    // Indicator for NPC
    const interactionIndicator = BABYLON.MeshBuilder.CreatePlane("npcIndicator",{size:0.5},scene);
    interactionIndicator.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;
    interactionIndicator.parent = npc;
    interactionIndicator.position.y = 2.5;
    interactionIndicator.material = new BABYLON.StandardMaterial("iMat",scene);
    interactionIndicator.material.emissiveColor = new BABYLON.Color3(1,1,0);
    interactionIndicator.isVisible = false;

    // ITEM
    const item = BABYLON.MeshBuilder.CreateSphere("item",{diameter:0.6},scene);
    item.material = new BABYLON.StandardMaterial("itemMat",scene);
    item.material.emissiveColor = new BABYLON.Color3(1,0.6,0);
    item.position = new BABYLON.Vector3(-5,0.4,-3);
    item.checkCollisions = false;

    // GUI
    const ui = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

    const dialogBox = new BABYLON.GUI.Rectangle();
    dialogBox.width = "800px";
    dialogBox.height = "150px";
    dialogBox.cornerRadius = 10;
    dialogBox.color = "white";
    dialogBox.thickness = 3;
    dialogBox.background = "rgba(0,0,0,0.9)";
    dialogBox.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    dialogBox.isVisible = false;
    ui.addControl(dialogBox);

    const dialogText = new BABYLON.GUI.TextBlock();
    dialogText.color = "white";
    dialogText.fontSize = 20;
    dialogText.textWrapping = true;
    dialogText.paddingLeft = 20;
    dialogText.paddingRight = 20;
    dialogBox.addControl(dialogText);

    function showDialog(text){
        dialogText.text = text;
        dialogBox.isVisible = true;
        gameState.dialogOpen = true;

        setTimeout(()=>{
            dialogBox.isVisible = false;
            gameState.dialogOpen = false;
        },3000);
    }

    // ‚≠ê AJOUT : MURS INVISIBLES POUR COLLISIONS
    function createWall(x,z,w,h,d){
        const wbox = BABYLON.MeshBuilder.CreateBox("wall",{width:w,height:h,depth:d},scene);
        wbox.position = new BABYLON.Vector3(x,h/2,z);
        wbox.checkCollisions = true;
        wbox.isVisible = false;
    }

    createWall(0,25,50,3,1);
    createWall(0,-25,50,3,1);
    createWall(25,0,1,3,50);
    createWall(-25,0,1,3,50);

    // ‚≠ê CAMERA (inchang√©e)
    const camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0,17,-20), scene);
    camera.lockedTarget = player;
    camera.radius = 20;
    camera.heightOffset = 17;
    camera.rotationOffset = 90;
    camera.cameraAcceleration = 0.05;
    camera.maxCameraSpeed = 10;

    // CLAVIER
    const inputMap = {};
    scene.onKeyboardObservable.add((kb)=>{
        const key = kb.event.key.toLowerCase();

        if(kb.type === BABYLON.KeyboardEventTypes.KEYDOWN){
            inputMap[key] = true;

            if(key==="e" && !gameState.menuOpen && !gameState.dialogOpen){
                handleInteraction();
            }

            if(key==="m") gameState.menuOpen = !gameState.menuOpen;

            if(kb.event.key==="Shift"){
                gameState.isRunning = true;
            }
        }

        if(kb.type === BABYLON.KeyboardEventTypes.KEYUP){
            inputMap[key] = false;

            if(kb.event.key==="Shift"){
                gameState.isRunning = false;
            }
        }
    });

    // ‚≠ê GESTION INTERACTIONS
    function handleInteraction(){
        const distNPC = BABYLON.Vector3.Distance(player.position,npc.position);
        if(distNPC < gameState.interactionRange){
            showDialog("Bonjour dresseur !");
            return;
        }

        const distItem = BABYLON.Vector3.Distance(player.position,item.position);
        if(distItem < gameState.interactionRange && item.isVisible){
            showDialog("Vous avez trouv√© une Super Potion !");
            item.isVisible = false;
            gameState.playerInventory.push("Super Potion x1");
        }
    }

    // ‚≠ê INDICATEUR INTERACTION
    function updateInteractionIndicator(){
        const distNPC = BABYLON.Vector3.Distance(player.position,npc.position);
        interactionIndicator.isVisible = (distNPC < gameState.interactionRange);
    }

    // ‚≠ê DEPLACEMENT + ORIENTATION
    scene.onBeforeRenderObservable.add(()=>{
        if(gameState.menuOpen || gameState.dialogOpen) return;

        const speed = gameState.isRunning ? 0.2 : 0.1;

        let dx = 0;
        let dz = 0;

        if(inputMap["z"]||inputMap["w"]) dx -= speed;
        if(inputMap["s"])              dx += speed;
        if(inputMap["d"])              dz += speed;
        if(inputMap["a"]||inputMap["q"]) dz -= speed;

        // Orientation
        if(dx!==0 || dz!==0){
            player.rotation.y = Math.atan2(dx, dz);
        }

        // D√©placement avec collisions
        const move = new BABYLON.Vector3(dx,0,dz);
        player.moveWithCollisions(move);

        updateInteractionIndicator();
    });

    return scene;
}

const scene = createScene();
engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
