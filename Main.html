<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PokÃ©mon-like Game</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #renderCanvas { width: 100%; height: 100vh; touch-action: none; }
        #instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.8;
            font-family: Arial, sans-serif;
        }
        #instructions strong { color: #FFD700; }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>

    <div id="instructions">
        <strong>ðŸŽ® ContrÃ´les Clavier:</strong><br>
        ZQSD / FlÃ¨ches : DÃ©placer<br>
        Shift : Courir<br>
        E : Interagir<br>
        M : Menu<br>
        Ã‰chap : Fermer menu<br><br>

        <strong>ðŸŽ® ContrÃ´les Manette:</strong><br>
        Stick gauche : DÃ©placer<br>
        X : Courir<br>
        A : Interagir<br>
        Y : Menu
    </div>

    <!-- Babylon JS -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>

<script>
const canvas   = document.getElementById("renderCanvas");
const engine   = new BABYLON.Engine(canvas, true);
let   gamepad  = null;

const gameState = {
    menuOpen: false,
    dialogOpen: false,
    isRunning: false,
    interactionRange: 3,
    playerInventory: ["Potion x3", "PokÃ© Ball x5", "Antidote x1"],
    playerName: "Red",
    money: 500
};

function createScene() {
    const scene = new BABYLON.Scene(engine);
    scene.collisionsEnabled = true;

    //----------------------------------------
    // LUMIÃˆRE + SOL
    //----------------------------------------
    new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width:50,height:50}, scene);
    ground.material = new BABYLON.StandardMaterial("groundMat", scene);
    ground.material.diffuseColor = new BABYLON.Color3(0.3, 0.7, 0.3);
    ground.checkCollisions = true;

    //----------------------------------------
    // PLAYER COLLIDER
    //----------------------------------------
    const playerCollider = BABYLON.MeshBuilder.CreateBox("playerCollider", {
        width: 1, height: 1, depth: 1
    }, scene);
    playerCollider.position = new BABYLON.Vector3(0,0.5,0);
    playerCollider.isVisible = false;
    playerCollider.checkCollisions = true;
    playerCollider.ellipsoid = new BABYLON.Vector3(0.5,0.5,0.5);
    playerCollider.ellipsoidOffset = new BABYLON.Vector3(0,0.5,0);

    //----------------------------------------
    // PLAYER VISUEL
    //----------------------------------------
    const player = BABYLON.MeshBuilder.CreateSphere("player", {diameter:1}, scene);
    const pmat = new BABYLON.PBRMaterial("pmat", scene);
    pmat.albedoColor = new BABYLON.Color3(1,0.4,0);
    player.material = pmat;
    player.parent = playerCollider;

    //----------------------------------------
    // NPC
    //----------------------------------------
    const npc = BABYLON.MeshBuilder.CreateBox("npc",{height:1.8,width:0.8,depth:0.8},scene);
    npc.position = new BABYLON.Vector3(5,0.9,5);
    npc.material = new BABYLON.StandardMaterial("npcMat", scene);
    npc.material.diffuseColor = new BABYLON.Color3(0,0,1);

    // NPC Indicator
    const npcIndicator = BABYLON.MeshBuilder.CreatePlane("npcIndicator",{size:0.5},scene);
    npcIndicator.position.y = 2.2;
    npcIndicator.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;
    npcIndicator.material = new BABYLON.StandardMaterial("npcIndMat",scene);
    npcIndicator.material.emissiveColor = new BABYLON.Color3(1,1,0);
    npcIndicator.parent = npc;
    npcIndicator.isVisible = false;

    //----------------------------------------
    // ITEM
    //----------------------------------------
    const item = BABYLON.MeshBuilder.CreateSphere("item",{diameter:0.6},scene);
    item.position = new BABYLON.Vector3(-5,0.4,-3);
    item.material = new BABYLON.StandardMaterial("itemMat",scene);
    item.material.emissiveColor = new BABYLON.Color3(1,0.7,0);

    const baseItemY = item.position.y;
    scene.onBeforeRenderObservable.add(() => {
        if (item.isVisible) {
            item.position.y = baseItemY + Math.sin(performance.now() * 0.004) * 0.1;
            item.rotation.y += 0.03;
        }
    });

    //----------------------------------------
    // MURS INVISIBLES
    //----------------------------------------
    function createWall(x,z,w,h,d){
        const wall = BABYLON.MeshBuilder.CreateBox("wall",{width:w,height:h,depth:d},scene);
        wall.position = new BABYLON.Vector3(x, h/2, z);
        wall.checkCollisions = true;
        wall.isVisible = false;
    }
    createWall(0, 25, 50, 3, 1);
    createWall(0,-25, 50, 3, 1);
    createWall(25, 0, 1, 3, 50);
    createWall(-25,0, 1, 3, 50);

    //----------------------------------------
    // FOLLOW CAMERA
    //----------------------------------------
    const camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0,17,-20), scene);
    camera.lockedTarget       = playerCollider;
    camera.radius             = 20;
    camera.heightOffset       = 17;
    camera.rotationOffset     = 90;
    camera.cameraAcceleration = 0.05;
    camera.maxCameraSpeed     = 10;

    //----------------------------------------
    // GUI SYSTEM
    //----------------------------------------
    const ui = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

    // SPEED INDICATOR
    const speedIndicator = new BABYLON.GUI.TextBlock();
    speedIndicator.text  = "ðŸš¶ Marche";
    speedIndicator.color = "white";
    speedIndicator.fontSize = 18;
    speedIndicator.top   = "10px";
    speedIndicator.left  = "10px";
    speedIndicator.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
    speedIndicator.verticalAlignment   = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
    ui.addControl(speedIndicator);

    //----------------------------------------
    // MENU PRINCIPAL â€” RESPONSIVE
    //----------------------------------------
    const menuPanel = new BABYLON.GUI.Rectangle();
    menuPanel.width  = "40%";
    menuPanel.height = "60%";
    menuPanel.cornerRadius = 25;
    menuPanel.color = "white";
    menuPanel.thickness = 3;
    menuPanel.background = "rgba(0, 0, 50, 0.60)";
    menuPanel.isVisible = false;
    menuPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
    menuPanel.verticalAlignment   = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
    ui.addControl(menuPanel);

    const menuStack = new BABYLON.GUI.StackPanel();
    menuStack.width  = "80%";
    menuStack.height = "90%";
    menuStack.verticalAlignment   = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
    menuStack.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
    menuStack.spacing = 20;
    menuPanel.addControl(menuStack);

    const menuTitle = new BABYLON.GUI.TextBlock();
    menuTitle.text = "MENU";
    menuTitle.height = "60px";
    menuTitle.color = "yellow";
    menuTitle.fontSize = 32;
    menuTitle.fontWeight = "bold";
    menuStack.addControl(menuTitle);

    // --- Boutons du menu principal ---
    function createMainButton(text) {
        const btn = BABYLON.GUI.Button.CreateSimpleButton("btn_" + text, text);
        btn.height = "60px";
        btn.color = "white";
        btn.background = "#1E4AA8";
        btn.fontSize = 22;
        btn.cornerRadius = 10;
        btn.onPointerEnterObservable.add(()=> btn.background = "#245edb");
        btn.onPointerOutObservable.add(()=> btn.background = "#1E4AA8");
        menuStack.addControl(btn);
        return btn;
    }

    const btnInv     = createMainButton("Inventaire");
    const btnMap     = createMainButton("Carte");
    const btnSave    = createMainButton("Sauvegarde");
    const btnOptions = createMainButton("Options");

    const btnCloseMain = BABYLON.GUI.Button.CreateSimpleButton("btnCloseMain","Fermer le menu");
    btnCloseMain.height = "60px";
    btnCloseMain.color = "white";
    btnCloseMain.background = "#3A8F3A";
    btnCloseMain.fontSize = 22;
    btnCloseMain.cornerRadius = 10;
    btnCloseMain.onPointerEnterObservable.add(()=> btnCloseMain.background = "#46a946");
    btnCloseMain.onPointerOutObservable.add(()=> btnCloseMain.background = "#3A8F3A");
    btnCloseMain.onPointerClickObservable.add(() => closeAllMenus());
    menuStack.addControl(btnCloseMain);

    //----------------------------------------
    // SOUS-MENU INVENTAIRE â€” GRILLE RPG
    //----------------------------------------
    const inventoryPanel = new BABYLON.GUI.Rectangle();
    inventoryPanel.width  = "50%";
    inventoryPanel.height = "70%";
    inventoryPanel.cornerRadius = 25;
    inventoryPanel.color = "white";
    inventoryPanel.thickness = 3;
    inventoryPanel.background = "rgba(10, 10, 40, 0.9)";
    inventoryPanel.isVisible = false;
    inventoryPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
    inventoryPanel.verticalAlignment   = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
    ui.addControl(inventoryPanel);

    const invStack = new BABYLON.GUI.StackPanel();
    invStack.width  = "90%";
    invStack.height = "100%";
    invStack.spacing = 10;
    invStack.paddingTop = "15px";
    inventoryPanel.addControl(invStack);

    const invTitle = new BABYLON.GUI.TextBlock();
    invTitle.text = "Inventaire";
    invTitle.height = "50px";
    invTitle.color = "yellow";
    invTitle.fontSize = 28;
    invTitle.fontWeight = "bold";
    invStack.addControl(invTitle);

    const invScroll = new BABYLON.GUI.ScrollViewer();
    invScroll.width  = "100%";
    invScroll.height = "70%";
    invScroll.barThickness = 6;
    invScroll.thumbLength  = 0.3;
    invScroll.forceHorizontalBar = false;
    invScroll.forceVerticalBar   = true;
    invStack.addControl(invScroll);

    const invGrid = new BABYLON.GUI.Grid();
    invGrid.width = "100%";
    invGrid.height = "100%";
    invGrid.addColumnDefinition(1/3, false);
    invGrid.addColumnDefinition(1/3, false);
    invGrid.addColumnDefinition(1/3, false);
    invScroll.addControl(invGrid);

    // boutons bas d'inventaire
    const invButtonsRow = new BABYLON.GUI.StackPanel();
    invButtonsRow.isVertical = false;
    invButtonsRow.height = "50px";
    invButtonsRow.spacing = 20;
    invStack.addControl(invButtonsRow);

    const btnInvBack = BABYLON.GUI.Button.CreateSimpleButton("btnInvBack","Retour");
    btnInvBack.width = "45%";
    btnInvBack.height = "45px";
    btnInvBack.color = "white";
    btnInvBack.background = "#1E4AA8";
    btnInvBack.fontSize = 20;
    btnInvBack.cornerRadius = 10;
    btnInvBack.onPointerClickObservable.add(()=>{
        inventoryPanel.isVisible = false;
        menuPanel.isVisible = true;
    });
    invButtonsRow.addControl(btnInvBack);

    const btnInvClose = BABYLON.GUI.Button.CreateSimpleButton("btnInvClose","Fermer");
    btnInvClose.width = "45%";
    btnInvClose.height = "45px";
    btnInvClose.color = "white";
    btnInvClose.background = "#3A8F3A";
    btnInvClose.fontSize = 20;
    btnInvClose.cornerRadius = 10;
    btnInvClose.onPointerClickObservable.add(()=>{
        closeAllMenus();
    });
    invButtonsRow.addControl(btnInvClose);

    // Fonction pour remplir la grille d'inventaire
    function refreshInventoryUI() {
        invGrid.clearControls();
        invGrid.rowDefinitions = [];
        const items = gameState.playerInventory;
        const cols  = 3;
        const cellHeight = 80;

        const rowCount = Math.ceil(items.length / cols) || 1;
        for (let r = 0; r < rowCount; r++) {
            invGrid.addRowDefinition(cellHeight, true);
        }

        items.forEach((label, index) => {
            const row = Math.floor(index / cols);
            const col = index % cols;

            const cell = new BABYLON.GUI.Rectangle("cell_"+index);
            cell.thickness = 2;
            cell.color = "white";
            cell.cornerRadius = 10;
            cell.background = "rgba(40,80,160,0.8)";

            const txt = new BABYLON.GUI.TextBlock();
            txt.text = label;
            txt.color = "white";
            txt.fontSize = 18;
            txt.textWrapping = true;
            cell.addControl(txt);

            invGrid.addControl(cell, row, col);
        });
    }

    refreshInventoryUI();

    // Liens boutons â†’ sous-menus
    btnInv.onPointerClickObservable.add(()=>{
        menuPanel.isVisible = false;
        inventoryPanel.isVisible = true;
        refreshInventoryUI();
    });

    btnMap.onPointerClickObservable.add(()=>{
        showDialog("La carte n'est pas encore disponible !");
    });

    btnSave.onPointerClickObservable.add(()=>{
        showDialog("Partie sauvegardÃ©e âœ”");
    });

    btnOptions.onPointerClickObservable.add(()=>{
        showDialog("Menu options en dÃ©veloppement.");
    });

    //----------------------------------------
    // TOGGLE MENUS
    //----------------------------------------
    function openMainMenu() {
        gameState.menuOpen = true;
        menuPanel.isVisible = true;
        inventoryPanel.isVisible = false;
    }

    function closeAllMenus() {
        gameState.menuOpen = false;
        menuPanel.isVisible = false;
        inventoryPanel.isVisible = false;
    }

    function toggleMenu(){
        if (gameState.menuOpen) {
            closeAllMenus();
        } else {
            openMainMenu();
        }
    }

    //----------------------------------------
// MENU GAMEPAD NAVIGATION
//----------------------------------------

let menuButtons = [btnInv, btnMap, btnSave, btnOptions, btnCloseMain];
let selectedIndex = 0;

function highlightMenuButton(){
    menuButtons.forEach((b,i)=>{
        b.background = (i === selectedIndex) ? "#3A80FF" : "#1E4AA8";
    });
}
highlightMenuButton();

function navigateMenu(button){
    // Croix haut/bas = dÃ©placement
    if (button === 12) { // UP
        selectedIndex = (selectedIndex - 1 + menuButtons.length) % menuButtons.length;
        highlightMenuButton();
    }
    if (button === 13) { // DOWN
        selectedIndex = (selectedIndex + 1) % menuButtons.length;
        highlightMenuButton();
    }

    // A = activation
    if (button === GamepadMap.interagir) {
        menuButtons[selectedIndex].onPointerClickObservable.notifyObservers();
    }
}

    //----------------------------------------
    // DIALOG BOX
    //----------------------------------------
    const dialogBox = new BABYLON.GUI.Rectangle();
    dialogBox.width = "800px";
    dialogBox.height = "150px";
    dialogBox.cornerRadius = 10;
    dialogBox.color = "white";
    dialogBox.thickness = 3;
    dialogBox.background = "rgba(0,0,0,0.9)";
    dialogBox.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
    dialogBox.top = "-40px";
    dialogBox.isVisible = false;
    ui.addControl(dialogBox);

    const dialogText = new BABYLON.GUI.TextBlock();
    dialogText.text = "";
    dialogText.color = "white";
    dialogText.fontSize = 18;
    dialogText.textWrapping = true;
    dialogText.resizeToFit = true;
    dialogText.paddingLeft = "20px";
    dialogText.paddingRight = "20px";
    dialogBox.addControl(dialogText);

    function showDialog(text){
        dialogText.text = text;
        dialogBox.isVisible = true;
        gameState.dialogOpen = true;

        setTimeout(()=>{
            dialogBox.isVisible = false;
            gameState.dialogOpen = false;
        }, 3000);
    }

    //----------------------------------------
    // CLAVIER
    //----------------------------------------
    const inputMap = {};

    scene.onKeyboardObservable.add(kb => {
        const key = kb.event.key.toLowerCase();

        if (kb.type === BABYLON.KeyboardEventTypes.KEYDOWN) {
            inputMap[key] = true;

            if (key === "e" && !gameState.menuOpen) handleInteraction();
            if (key === "m") toggleMenu();
            if (kb.event.key === "Escape" && gameState.menuOpen) closeAllMenus();
            if (kb.event.key === "Shift") gameState.isRunning = true;
        }

        if (kb.type === BABYLON.KeyboardEventTypes.KEYUP) {
            inputMap[key] = false;
            if (kb.event.key === "Shift") gameState.isRunning = false;
        }
    });

    //----------------------------------------
    // GAMEPAD FIX + MAPPING STABLE
    //----------------------------------------

    const GamepadMap = {
        courir:    2,  // X
        interagir: 0,  // A
        menu:      3   // Y
    };

    let buttonPressed = {};

    const gpManager = new BABYLON.GamepadManager();
    gpManager.onGamepadConnectedObservable.add(gp=>{
        gamepad = gp;

        gp.onButtonDownObservable.add(button=>{
            if (buttonPressed[button]) return;
            buttonPressed[button] = true;

            if (button === GamepadMap.menu) toggleMenu();
            if (button === GamepadMap.interagir && !gameState.menuOpen) handleInteraction();
            if (button === GamepadMap.courir) gameState.isRunning = true;

            // Navigation menu
            if (gameState.menuOpen) navigateMenu(button);
        });

        gp.onButtonUpObservable.add(button=>{
            buttonPressed[button] = false;

            if (button === GamepadMap.courir) gameState.isRunning = false;
        });
    });

    //----------------------------------------
    // INTERACTIONS
    //----------------------------------------
    function handleInteraction(){
        const pos = playerCollider.position;

        // NPC
        if (BABYLON.Vector3.Distance(pos,npc.position) < gameState.interactionRange){
            showDialog("Bonjour ! Bienvenue dans ce monde PokÃ©mon.");
            return;
        }

        // ITEM
        if (item.isVisible &&
            BABYLON.Vector3.Distance(pos,item.position) < gameState.interactionRange){
            showDialog("Vous trouvez une Super Potion !");
            item.isVisible = false;
            gameState.playerInventory.push("Super Potion x1");
            refreshInventoryUI();
        }
    }

    //----------------------------------------
    // UPDATE NPC INDICATOR
    //----------------------------------------
    function updateNpcIndicator(){
        npcIndicator.isVisible =
            BABYLON.Vector3.Distance(playerCollider.position, npc.position)
            < gameState.interactionRange;
    }

    //----------------------------------------
    // MOVEMENT + GAMEPAD FIX
    //----------------------------------------
    scene.onBeforeRenderObservable.add(()=>{
        if (gameState.menuOpen || gameState.dialogOpen) return;

        const speed = gameState.isRunning ? 0.2 : 0.1;

        let dx = 0, dz = 0;

        // --- CLAVIER ---
        if (inputMap["z"] || inputMap["w"]) dx -= speed;
        if (inputMap["s"]) dx += speed;
        if (inputMap["d"]) dz += speed;
        if (inputMap["a"] || inputMap["q"]) dz -= speed;

        // --- GAMEPAD FIX ---
        if (gamepad) {

            // Deadzone (Ã©vite les dÃ©placements automatiques)
            const DEADZONE = 0.25;

            let stickX = Math.abs(gamepad.leftStick.x) > DEADZONE ? gamepad.leftStick.x : 0;
            let stickY = Math.abs(gamepad.leftStick.y) > DEADZONE ? gamepad.leftStick.y : 0;

            // Correction inversion Y â†’ vers l'avant = -Y
            dx += stickY * speed;
            dz += stickX * speed ;
        }

        if (dx !== 0 || dz !== 0) {
            player.rotation.y = Math.atan2(dx, dz);
        }

        playerCollider.moveWithCollisions(new BABYLON.Vector3(dx,0,dz));
        updateNpcIndicator();
    });

    return scene;
}

const scene = createScene();
engine.runRenderLoop(()=> scene.render());
window.addEventListener("resize", () => engine.resize());
</script>
</body>
</html>
